---
title: MCP Servers
---

# MCP Servers

Agent Runtimes provides comprehensive support for **MCP Servers**, enabling agents to access external tools and data sources through a standardized interface.

## Overview

MCP servers are external processes that provide tools, resources, and prompts to AI agents. Agent Runtimes manages these servers automatically:

- **Automatic Server Lifecycle** — MCP servers start with the application and stop on shutdown
- **Retry with Backoff** — Transient failures trigger automatic retries with exponential backoff
- **Sequential Startup** — Multiple MCP servers start sequentially to avoid resource conflicts
- **Status Monitoring** — Real-time status of all MCP toolsets via API endpoint

## MCP Server Examples

Agent Runtimes supports **any MCP-compatible server**—if it follows the [MCP specification](https://modelcontextprotocol.io/), it will work. The table below shows a few popular examples to get you started:

| Server | Package/URL | Type | Description |
|--------|-------------|------|-------------|
| Tavily | `tavily-mcp` | Local | Web search and content extraction |
| Filesystem | `@modelcontextprotocol/server-filesystem` | Local | File system access |
| GitHub | `@modelcontextprotocol/server-github` | Local | GitHub repository access |
| Brave Search | `@modelcontextprotocol/server-brave-search` | Local | Web search |
| LinkedIn | [stickerdaniel/linkedin-mcp-server](https://github.com/stickerdaniel/linkedin-mcp-server) | Local | LinkedIn profile, company, and job data |
| Kaggle | `https://www.kaggle.com/mcp` | Remote | Kaggle datasets, models, competitions, notebooks |

:::info Local vs Remote MCP Servers
- **Local servers** run as child processes on your machine (started via `npx` or `uvx`)
- **Remote servers** are hosted externally and accessed over HTTP (e.g., Kaggle MCP)

Both types are configured in the same `mcp.json` file, but remote servers use `mcp-remote` as a bridge.
:::

See the [MCP Servers Directory](https://github.com/modelcontextprotocol/servers) for more options.

## Quick Start

### Basic Configuration

MCP servers are configured in `~/.datalayer/mcp.json`. Here's a minimal example:

```json
{
  "mcpServers": {
    "tavily": {
      "command": "npx",
      "args": ["-y", "tavily-mcp@0.1.3"],
      "env": {
        "TAVILY_API_KEY": "${TAVILY_API_KEY}"
      }
    }
  }
}
```

Environment variables are automatically expanded using `${VAR_NAME}` syntax.

### Using MCP Tools in Agents

Once configured, agents automatically receive access to all running MCP toolsets:

```python
from pydantic_ai import Agent
from agent_runtimes.mcp import get_mcp_toolsets

# Get pre-loaded MCP toolsets
mcp_toolsets = get_mcp_toolsets()

# Create agent with MCP tools
agent = Agent(
    "anthropic:claude-sonnet-4-20250514",
    system_prompt="You are a helpful assistant.",
    toolsets=mcp_toolsets,
)
```

### Full Configuration Example

Here's a complete configuration with multiple servers:

```json
{
  "mcpServers": {
    "tavily": {
      "command": "npx",
      "args": ["-y", "tavily-mcp@0.1.3"],
      "env": {
        "TAVILY_API_KEY": "${TAVILY_API_KEY}"
      }
    },
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed/dir"]
    },
    "linkedin": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/stickerdaniel/linkedin-mcp-server",
        "linkedin-mcp-server"
      ]
    },
    "kaggle": {
      "command": "npx",
      "args": ["-y", "mcp-remote", "https://www.kaggle.com/mcp"]
    }
  }
}
```

## Server-Specific Setup

Some MCP servers require additional setup beyond basic configuration.

### Kaggle MCP Server

The [Kaggle MCP Server](https://www.kaggle.com/docs/mcp) is a **remote HTTP server** that provides access to Kaggle datasets, models, competitions, notebooks, and benchmarks.

#### Configuration Options

**Option 1: Token Authentication (recommended for Agent Runtimes)**

```json
{
  "mcpServers": {
    "kaggle": {
      "command": "npx",
      "args": [
        "-y",
        "mcp-remote",
        "https://www.kaggle.com/mcp",
        "--header",
        "Authorization: Bearer ${KAGGLE_TOKEN}"
      ]
    }
  }
}
```

To get your token:
1. Go to **[kaggle.com/settings/account](https://www.kaggle.com/settings/account)**
2. Scroll to **API** section → Click **Create New Token**
3. Open the downloaded `kaggle.json` and copy the `key` value
4. Set the environment variable: `export KAGGLE_TOKEN=your-key-here`

For Agent Runtimes identity integration, see the [Kaggle section](../identity#kaggle) in the Identity documentation.

**Option 2: Browser OAuth (auto-login)**

```json
{
  "mcpServers": {
    "kaggle": {
      "command": "npx",
      "args": ["-y", "mcp-remote", "https://www.kaggle.com/mcp"]
    }
  }
}
```

This triggers a browser-based login on first tool call. Tokens are cached automatically.

#### Available Tools

| Category | Description |
|----------|-------------|
| **Notebooks** | Create, run, and manage Kaggle notebooks |
| **Datasets** | Search, download, and explore datasets |
| **Models** | Access and use Kaggle models |
| **Competitions** | Browse competitions, download data, submit predictions |
| **Benchmarks** | Access Kaggle benchmark tools |

### LinkedIn MCP Server

The LinkedIn MCP server requires browser automation via Playwright.

#### Setup Steps

**Step 1: Install Playwright Chromium**

```bash
uvx --from playwright playwright install chromium
```

**Step 2: Create a Session File**

```bash
uvx --from git+https://github.com/stickerdaniel/linkedin-mcp-server linkedin-mcp-server --get-session
```

This opens a browser window for manual LinkedIn login (handles 2FA, captcha, etc.). You have 5 minutes to complete authentication. The session is saved to `~/.linkedin-mcp/session.json`.

**Step 3: Add to Configuration**

```json
{
  "mcpServers": {
    "linkedin": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/stickerdaniel/linkedin-mcp-server",
        "linkedin-mcp-server"
      ]
    }
  }
}
```

:::warning Session Expiration
Sessions may expire over time. If you encounter authentication errors, run `--get-session` again.
:::

:::tip Alternative: Cookie Authentication
You can also authenticate using your `li_at` cookie:
```json
"env": {
  "LINKEDIN_COOKIE": "${LINKEDIN_COOKIE}"
}
```
To get the cookie: DevTools (F12) → Application → Cookies → linkedin.com → copy `li_at` value.
However, session file authentication is more reliable.
:::

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   FastAPI Application                        │
│                    (agent_runtimes)                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ↓ Lifespan startup
┌─────────────────────────────────────────────────────────────┐
│               MCP Toolsets Manager                           │
│        (agent_runtimes/mcp/toolsets.py)                     │
└─────────────────────────────────────────────────────────────┘
          │                   │                   │
          ↓                   ↓                   ↓
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Tavily    │     │  LinkedIn   │     │   Kaggle    │
│ MCP Server  │     │ MCP Server  │     │ MCP Server  │
│  (local)    │     │  (local)    │     │  (remote)   │
└─────────────┘     └─────────────┘     └─────────────┘
```

### Server Startup Sequence

1. **Load Configuration** — Read `~/.datalayer/mcp.json` and expand environment variables
2. **Sequential Start** — Start each MCP server one at a time to avoid resource conflicts
3. **Retry Logic** — If a server fails with `BrokenResourceError`, retry up to 3 times with backoff
4. **Tool Discovery** — Once connected, list available tools from each server
5. **Status Tracking** — Track ready/failed servers for monitoring

## API Endpoints

### Status and Info

**Get MCP Toolsets Status**

```bash
GET /api/v1/configure/mcp-toolsets-status
```

```json
{
  "initialized": true,
  "ready_count": 2,
  "failed_count": 0,
  "ready_servers": ["tavily", "kaggle"],
  "failed_servers": {}
}
```

**Get MCP Toolsets Info**

```bash
GET /api/v1/configure/mcp-toolsets-info
```

```json
[
  {
    "type": "MCPServerStdio",
    "id": "tavily",
    "command": "npx",
    "args": ["-y", "tavily-mcp@0.1.3"]
  }
]
```

### Server Management

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/v1/mcp/servers` | GET | List all configured MCP servers |
| `/api/v1/mcp/servers/{id}` | GET | Get specific MCP server details |
| `/api/v1/mcp/servers` | POST | Add a new MCP server |
| `/api/v1/mcp/servers/{id}` | PUT | Update an MCP server |
| `/api/v1/mcp/servers/{id}` | DELETE | Remove an MCP server |

## UI Integration

The Agent Details panel in the chat UI displays real-time MCP toolsets status:

- ✓ Ready servers with green checkmarks
- ✗ Failed servers with error details
- Auto-refresh every 5 seconds

## Troubleshooting

### Debug Logging

Enable debug logging to see detailed MCP startup information:

```bash
python -m agent_runtimes --debug
```

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| **Timeout during startup** | First-time package downloads can take minutes | Wait for download to complete; default timeout is 5 minutes |
| **BrokenResourceError** | MCP server process crashed | Automatic retry (up to 3 times); check server logs |
| **Server not starting** | Missing command or env vars | Verify `npx`/`uvx` exists; check environment variables |
| **LinkedIn browser error** | Playwright not installed | Run `uvx --from playwright playwright install chromium` |
| **Kaggle permission error** | Not authenticated | Complete OAuth flow or set `KAGGLE_TOKEN` |
